workflows:
  cicd_app_tf:
    jobs:
      - test_unit:
          context:
            - node
      - test_e2e:
          context:
            - node
      - build:
          context:
            - node
          requires:
            - test_unit
            - test_e2e
          filters:
            branches:
              only:
                - master

      - terraform_validate:
          context:
            - node
      - terraform_plan_dev:
          context:
            - node
          requires:
            - terraform_validate
      - terraform_deploy_dev:
          context:
            - node
          requires:
            - terraform_plan_dev
          filters:
            branches:
              only: master

      - deploy_development:
          context:
            - node
          requires:
            - build
            - terraform_deploy_dev
          filters:
            branches:
              only:
                - master

      - terraform_plan_prod:
          context:
            - node
          requires:
            - terraform_validate
      - approve_deploy_prod:
          type: approval
          requires:
            - terraform_plan_prod
          filters:
            branches:
              only: master
      - terraform_deploy_prod:
          context:
            - node
          requires:
            - approve_deploy_prod
          filters:
            branches:
              only: master

      - deploy_production:
          context:
            - node
          requires:
            - terraform_deploy_prod
          filters:
            branches:
              only: master
