description: >
  Typical usecase for:
  - validation and production plan on every push
  - deploy to dev on push to master
  - deploy to prod after approval

usage:
  version: 2.1
  orbs:
    fgr_terraform: figure/terraform@1.0.0

  workflows:
    terraform_validation_deploy:
      jobs:
        - terraform_plan_dev:
            context:
              - node
        - terraform_deploy_dev:
            context:
              - node
            requires:
              - terraform_plan_dev
            filters:
              branches:
                only: master
        - terraform_plan_prod:
            context:
              - node
        - approve_terraform_deploy_prod:
            requires:
              - terraform_plan_prod
            type: approval
            filters:
              branches:
                only: master
        - terraform_deploy_prod:
            context:
              - node
            requires:
              - approve_terraform_deploy_prod
            filters:
              branches:
                only: master

  jobs:
    terraform_plan_dev:
      docker:
        - image: figurepos/aws-node-terraform:node20
      steps:
        - checkout
        - fgr_terraform/plan:
            account_id: "880892332156"
            env: development
        - fgr_terraform/validate:
            account_id: "880892332156"

    terraform_deploy_dev:
      docker:
        - image: figurepos/aws-node-terraform:node20
      steps:
        - checkout
        - fgr_terraform/deploy:
            account_id: "880892332156"
            env: development

    terraform_plan_prod:
      docker:
        - image: figurepos/aws-node-terraform:node20
      steps:
        - checkout
        - fgr_terraform/plan:
            account_id: "682919404744"
            env: production

    terraform_deploy_prod:
      docker:
        - image: figurepos/aws-node-terraform:node20
      steps:
        - checkout
        - fgr_terraform/deploy:
            account_id: "682919404744"
            env: production
