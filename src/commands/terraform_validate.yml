description: >
  Validate terraform scripts and check them using Checkov.

parameters:
  account_id:
    type: string
    description: "AWS Account ID"
  bucket_name:
    type: string
    description: "Name of S3 Bucket with terraform state"
    default: ""
  dir:
    type: string
    default: "tf"
    description: "Directory of terraform scripts"
  env:
    type: string
    description: "Environment"
  run_checkov:
    type: boolean
    default: true
    description: "Whether to run checkov security checks or not"

steps:
  - run:
      name: Terraform Init
      environment:
        ACCOUNT_ID: <<parameters.account_id>>
        BUCKET_NAME: <<parameters.bucket_name>>
        DIR: <<parameters.dir>>
        ENV: "development"
        ROLE_NAME: "TerraformDeployer"
        SCRIPT_ASSUME: <<include(scripts/aws-assume.sh)>>
        SCRIPT_SET_VARS: <<include(scripts/set-variables.sh)>>
      command: <<include(scripts/terraform-init.sh)>>
  - run:
      name: Terraform Validate
      environment:
        DIR: <<parameters.dir>>
      command: |
        cd $DIR
        terraform validate
  - when:
      condition: <<parameters.run_checkov>>
      steps:
        - run:
            name: Terraform Init
            environment:
              ACCOUNT_ID: <<parameters.account_id>>
              BUCKET_NAME: <<parameters.bucket_name>>
              DIR: <<parameters.dir>>
              ENV: <<parameters.env>>
              ROLE_NAME: "TerraformDeployer"
              SCRIPT_ASSUME: <<include(scripts/aws-assume.sh)>>
              SCRIPT_SET_VARS: <<include(scripts/set-variables.sh)>>
            command: <<include(scripts/terraform-init.sh)>>
        - run:
            name: Terraform Plan
            environment:
              AWS_ACCESS_KEY_ID: ""
              AWS_SECRET_ACCESS_KEY: ""
              DIR: <<parameters.dir>>
              ENV: <<parameters.env>>
              TF_VAR_aws_profile: "assumed-role"
              TF_VAR_env: <<parameters.env>>
            command: <<include(scripts/terraform-plan.sh)>>
        - run:
            name: Checkov Static Check
            environment:
              DIR: <<parameters.dir>>
              CHECKOV_CONFIG: <<include(.checkov.terraform.yml)>>
            command: |
              cd $DIR
              echo "$CHECKOV_CONFIG" > .checkov.yml
              checkov -d . --config-file .checkov.yml
        - run:
            name: Checkov Plan Check
            environment:
              AWS_ACCESS_KEY_ID: ""
              AWS_SECRET_ACCESS_KEY: ""
              CHECKOV_CONFIG: <<include(.checkov.terraform-plan.yml)>>
              DIR: <<parameters.dir>>
              ENV: "development"
              ROLE_NAME: "TerraformDeployer"
              TF_VAR_aws_profile: "assumed-role"
              TF_VAR_env: "development"
            command: <<include(scripts/checkov-plan-check.sh)>>

