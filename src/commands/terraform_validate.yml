description: >
  Validate terraform scripts and check them using Checkov.

parameters:
  account_id:
    type: string
    description: "AWS Account ID"
  dir:
    type: string
    default: "tf"
    description: "Directory of terraform scripts"

steps:
  - run:
      name: Terraform Init
      environment:
        ACCOUNT_ID: <<parameters.account_id>>
        DIR: <<parameters.dir>>
        ENV: "development"
        ROLE_NAME: "TerraformDeployer"
        SCRIPT_ASSUME: <<include(scripts/aws-assume.sh)>>
        SCRIPT_SET_VARS: <<include(scripts/set-variables.sh)>>
      command: <<include(scripts/terraform-init.sh)>>
  - run:
      name: Terraform Format
      environment:
        DIR: <<parameters.dir>>
      command: |
        cd $DIR
        terraform fmt
  - run:
      name: Terraform Validate
      environment:
        DIR: <<parameters.dir>>
      command: |
        cd $DIR
        terraform validate
  - run:
      name: Checkov Static Check
      environment:
        DIR: <<parameters.dir>>
        CHECKOV_CONFIG: <<include(.checkov.terraform.yml)>>
      command: |
        cd $DIR
        echo "$CHECKOV_CONFIG" > .checkov.yml
        checkov -d . --config-file .checkov.yml
  - attach_workspace:
      at: /tmp/workspace
  - run:
      name: Checkov Plan Check
      environment:
        AWS_ACCESS_KEY_ID: ""
        AWS_SECRET_ACCESS_KEY: ""
        CHECKOV_CONFIG: <<include(.checkov.terraform-plan.yml)>>
        DIR: <<parameters.dir>>
        ENV: "development"
        ROLE_NAME: "TerraformDeployer"
        TF_VAR_aws_profile: "assumed-role"
        TF_VAR_env: "development"
      command: |
        cd $DIR
        if [ -f /tmp/workspace/tfplan.binary ] && [[ `cat /tmp/workspace/tfplan.change` == "true" ]];
        then
          terraform show -json /tmp/workspace/tfplan.binary > tfplan.json
          echo "$CHECKOV_CONFIG" > .checkov.yml
          checkov -f tfplan.json --config-file .checkov.yml
        else
          echo "No changes in the plan."
        fi
